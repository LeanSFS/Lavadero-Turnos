<!doctype html>
<html lang="es">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Lavado a Domicilio ‚Äì Reservas</title>
<style>
  :root{--bg:#0f172a;--card:#111827;--line:#1f2937;--muted:#9ca3af;--ok:#22c55e}
  body{font-family:system-ui,Arial;background:var(--bg);color:#fff;margin:0;padding:24px}
  .box{max-width:720px;margin:0 auto;background:#0b1220;border:1px solid var(--line);border-radius:16px;padding:18px}
  h1{margin:0 0 8px;font-size:22px}
  .muted{color:var(--muted);margin:0 0 16px}
  .days{display:flex;flex-direction:column;gap:10px;margin:10px 0 14px}
  .day{display:flex;align-items:center;gap:10px;border:1px solid var(--line);background:#0f172a;border-radius:12px;padding:12px}
  .right{margin-left:auto;color:var(--muted)}
  .slots{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 16px}
  .slot{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#111827;color:#e5e7eb;cursor:pointer}
  .slot.sel{outline:2px solid var(--ok)}
  input,select{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:#fff}
  label{display:block;margin:10px 0 6px}
  button{padding:12px 14px;border-radius:10px;border:1px solid var(--ok);background:var(--ok);color:#0b1220;font-weight:700;cursor:pointer}
  .msg{margin-top:10px;color:var(--muted);white-space:pre-wrap}
</style>

<div class="box">
  <h1>Lavado a Domicilio üöó‚ú®</h1>
  <p class="muted">Eleg√≠ el d√≠a, el horario disponible y el servicio. Te confirmamos por WhatsApp.</p>

  <div id="dias" class="days"></div>

  <div id="bloque-slots" style="display:none">
    <div class="muted" id="subfecha"></div>
    <div id="slots" class="slots"></div>
  </div>

  <label>Nombre y Apellido</label>
  <input id="nombre" placeholder="Juan P√©rez">
  <label>Tel√©fono</label>
  <input id="telefono" placeholder="2994...">
  <label>Direcci√≥n</label>
  <input id="direccion" placeholder="Calle y n√∫mero, barrio">
  <label>Servicio</label>
  <select id="servicio">
    <option value="Exterior">Exterior ‚Äì $15.000</option>
    <option value="Interior">Interior ‚Äì $15.000</option>
    <option value="Completo">Completo ‚Äì $20.000</option>
  </select>

  <div style="margin-top:14px">
    <button id="btn">Reservar</button>
  </div>
  <div id="msg" class="msg"></div>
</div>

<script>
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyDd--FDaQPnqG_LQ4MzLuRmIQc99Y0WK1Axpwh3Tc4GX1DLCHn77XTr2-wBZUVCuVO/exec';

const diasDiv = document.getElementById('dias');
const slotsDiv = document.getElementById('slots');
const bloqueSlots = document.getElementById('bloque-slots');
const subfecha = document.getElementById('subfecha');
const msg = document.getElementById('msg');
const S = { calendario: [], map: new Map(), selFecha:null, selHora:null };

const pad = n => String(n).padStart(2,'0');
function niceFecha(iso){
  const [y,m,d]=iso.split('-').map(Number);
  const dt=new Date(y,(m||1)-1,d);
  const dias = ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
  return `${dias[dt.getDay()]} ${pad(d)}/${pad(m)}`;
}

async function cargarDias(){
  msg.textContent = 'Cargando disponibilidad‚Ä¶';
  try{
    const url = `${WEBAPP_URL}?action=slots14&days=14&t=${Date.now()}`;
    const r = await fetch(url);
    const j = await r.json();
    if (!j.ok || !Array.isArray(j.rows)) throw new Error(j.error||'Respuesta inv√°lida');
    S.calendario = j.rows;
    S.map = new Map(S.calendario.map(x => [x.fecha, x.slots]));
    renderDias();
    msg.textContent = '';
  }catch(e){
    msg.textContent = '‚ö†Ô∏è No se pudieron cargar los d√≠as. ' + e.message;
  }
}

function renderDias(){
  diasDiv.innerHTML = S.calendario.map((d,i) => {
    const total = d.count ?? (d.slots ? d.slots.length : 0);
    return `
      <label class="day">
        <input type="radio" name="dia" value="${d.fecha}" ${i===0?'checked':''}>
        <div>${niceFecha(d.fecha)} ‚Äî <b>${total}</b> libres</div>
        <div class="right">${d.fecha}</div>
      </label>`;
  }).join('');
  const first = diasDiv.querySelector('input[name="dia"]');
  if (first){ first.dispatchEvent(new Event('change')); }
}

diasDiv.addEventListener('change', (ev)=>{
  if (ev.target.name !== 'dia') return;
  S.selFecha = ev.target.value;
  S.selHora = null;
  const libres = S.map.get(S.selFecha) || [];
  subfecha.textContent = `Horarios disponibles para ${S.selFecha}`;
  slotsDiv.innerHTML = libres.length
    ? libres.map(h => `<button class="slot" data-h="${h}">${h}</button>`).join('')
    : '<span class="muted">No hay horarios libres en este d√≠a.</span>';
  bloqueSlots.style.display = 'block';
});

slotsDiv.addEventListener('click',(ev)=>{
  const b = ev.target.closest('.slot'); if(!b) return;
  S.selHora = b.dataset.h;
  [...slotsDiv.querySelectorAll('.slot')].forEach(el => el.classList.toggle('sel', el===b));
});

document.getElementById('btn').onclick = async ()=>{
  msg.textContent = '';
  const nombre = document.getElementById('nombre').value.trim();
  const telefono = document.getElementById('telefono').value.trim();
  const direccion = document.getElementById('direccion').value.trim();
  const servicio = document.getElementById('servicio').value;

  if (!S.selFecha || !S.selHora || !nombre || !telefono || !direccion){
    msg.textContent = '‚ö†Ô∏è Complet√° todos los campos y eleg√≠ fecha y horario.'; return;
  }

  try{
    const qs = new URLSearchParams({
      action:'create',
      fecha:S.selFecha, hora:S.selHora, servicio,
      nombre, telefono, direccion
    });
    const r = await fetch(`${WEBAPP_URL}?${qs.toString()}`);
    const j = await r.json();
    if (!j.ok) throw new Error(j.error||'No se pudo reservar');
    // P√°gina de √©xito simple:
    location.href = 'ok.html';
  }catch(e){
    msg.textContent = '‚ö†Ô∏è ' + e.message;
  }
};

cargarDias();
</script>
</html>
