<!doctype html>
<html lang="es">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Reserv√° tu turno ‚Äì Lavado a Domicilio</title>
<style>
  :root{--bg:#0f172a;--card:#111827;--muted:#9ca3af;--pri:#22c55e}
  body{font-family:system-ui,Arial;background:var(--bg);color:#fff;min-height:100vh;margin:0;display:flex;align-items:center;justify-content:center}
  .wrap{width:100%;max-width:720px;padding:20px}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:18px}
  h1{margin:0 0 10px;font-size:22px}
  p{margin:0 0 14px;color:var(--muted)}
  label{display:block;margin:8px 0 6px;color:#e5e7eb;font-size:14px}
  input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #374151;background:#0b1220;color:#fff}
  .slots{margin-top:10px;display:flex;flex-wrap:wrap;gap:10px}
  .slot{padding:10px 14px;border:1px solid #374151;border-radius:10px;cursor:pointer}
  .slot.sel{background:var(--pri);color:#0b1220;border-color:var(--pri);font-weight:700}
  .btn{margin-top:10px;display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid #16a34a;background:#16a34a;color:#0b1220;font-weight:600;cursor:pointer}
  .msg{margin-top:10px;font-size:14px}
</style>

<div class="wrap">
  <div class="card">
    <h1>Lavado a Domicilio üöó‚ú®</h1>
    <p>Eleg√≠ el d√≠a, se cargar√°n los horarios disponibles y el servicio. Te confirmamos por WhatsApp.</p>

    <label>D√≠a (pr√≥ximos 14)</label>
    <select id="dia"></select>

    <div id="slots" class="slots"></div>

    <label>Nombre y Apellido</label>
    <input id="nombre" placeholder="Juan P√©rez">

    <label>Tel√©fono</label>
    <input id="tel" placeholder="2994...">

    <label>Direcci√≥n</label>
    <input id="dir" placeholder="Calle y n√∫mero, barrio">

    <label>Servicio</label>
    <select id="serv">
      <option>Exterior ‚Äì $15.000</option>
      <option>Interior ‚Äì $15.000</option>
      <option>Completo ‚Äì $20.000</option>
      <option>Encerado ‚Äì $12.000</option>
    </select>

    <button class="btn" id="btnSend">Reservar</button>
    <div id="msg" class="msg"></div>
  </div>
</div>

<script>
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzGlBMaIfEvI3j46lhelGCC0kb-RfF6LcXTKpUz_IObLcERxD5pEhcjCqE3BlicJ-Gw8w/exec';

const $ = id => document.getElementById(id);
let horaElegida = '';

const diasCorto = ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
const toISO = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const nice  = d => `${diasCorto[d.getDay()]} ${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`;

async function getSlots(fechaISO){
  try{
    const r = await fetch(`${WEBAPP_URL}?action=slots&fecha=${encodeURIComponent(fechaISO)}`);
    const j = await r.json();
    return (j.ok && Array.isArray(j.slots)) ? j.slots : [];
  }catch{ return []; }
}

// llena select con 14 d√≠as; luego actualiza etiquetas con ‚ÄúX libres‚Äù
async function renderDias(){
  const sel = $('dia'); sel.innerHTML = '';
  const hoy = new Date(); hoy.setHours(0,0,0,0);

  // 1) crear opciones b√°sicas de los pr√≥ximos 14 d√≠as
  const opciones = [];
  for(let i=0;i<14;i++){
    const d = new Date(hoy); d.setDate(hoy.getDate()+i);
    const iso = toISO(d);
    const opt = document.createElement('option');
    opt.value = iso;
    opt.textContent = `${nice(d)} ‚Äî cargando‚Ä¶`;
    sel.appendChild(opt);
    opciones.push({opt, iso, d});
  }
  sel.value = opciones[0].iso; // seleccionar primera

  // 2) cargar horarios del d√≠a seleccionado (auto)
  await cargarHorariosDelDia(sel.value);

  // 3) actualizar etiquetas con cantidad de libres (no bloqueante)
  for (const it of opciones){
    const libres = await getSlots(it.iso);
    it.opt.textContent = `${nice(it.d)} ‚Äî ${libres.length} libres`;
    // si quer√©s deshabilitar d√≠as sin turnos, descoment√°:
    // it.opt.disabled = libres.length === 0;
  }
}

async function cargarHorariosDelDia(iso){
  $('msg').textContent = '';
  $('slots').innerHTML = 'Cargando horarios‚Ä¶';
  const slots = await getSlots(iso);
  if(!slots.length){ $('slots').innerHTML = '<span style="color:#9ca3af">No hay horarios para ese d√≠a.</span>'; return; }
  horaElegida = '';
  $('slots').innerHTML = slots.map(h => `<span class="slot" data-h="${h}">${h}</span>`).join('');
  document.querySelectorAll('.slot').forEach(el=>{
    el.onclick = () => {
      document.querySelectorAll('.slot').forEach(s=>s.classList.remove('sel'));
      el.classList.add('sel');
      horaElegida = el.dataset.h;
      $('msg').textContent = `Horario elegido: ${horaElegida}`;
      $('msg').style.color = '#22c55e';
    };
  });
}

// al cambiar d√≠a ‚áí cargar horarios autom√°ticamente
$('dia').onchange = () => cargarHorariosDelDia($('dia').value);

// reservar (GET para evitar CORS)
$('btnSend').onclick = async () => {
  $('msg').textContent = '';
  const fecha    = $('dia').value;
  const nombre   = $('nombre').value.trim();
  const telefono = $('tel').value.trim();
  const direccion= $('dir').value.trim();
  const servicio = $('serv').value.split(' ‚Äì ')[0];

  if(!fecha || !horaElegida || !nombre || !telefono || !direccion){
    $('msg').textContent = 'Complet√° d√≠a, horario, nombre, tel√©fono y direcci√≥n.';
    $('msg').style.color='salmon';
    return;
  }

  const qs = new URLSearchParams({ action:'create', fecha, hora:horaElegida, servicio, nombre, telefono, direccion }).toString();
  try{
    const res  = await fetch(`${WEBAPP_URL}?${qs}`);
    const data = await res.json();
    if(data.ok){
      $('msg').textContent = '‚úÖ ¬°Turno reservado! Te confirmamos por WhatsApp.';
      $('msg').style.color = '#22c55e';
      $('slots').innerHTML = '';
      horaElegida = '';
      // refrescar cantidades
      renderDias();
    } else {
      $('msg').textContent = data.error || 'No se pudo reservar.'; $('msg').style.color='salmon';
    }
  }catch{
    $('msg').textContent = 'Error de red al reservar.'; $('msg').style.color='salmon';
  }
};

// init
renderDias();
</script>
</html>
