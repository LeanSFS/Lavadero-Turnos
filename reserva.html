<script>
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzIdrsdl5F0OBXeDj7QbOCInq-vppixmdwevqXC6CnMoQREHHsL8eVz1keR3Lbc8P2yVg/exec';
let horaElegida = '';

const $ = (id) => document.getElementById(id);
const show = (msg, ok=false) => { const el = $('msg'); el.textContent = msg; el.style.color = ok ? 'green' : 'crimson'; };

$('btnSlots').onclick = async () => {
  show('');
  const fecha = $('fecha').value;
  if (!fecha) { show('Elegí una fecha'); return; }

  try {
    const res = await fetch(`${WEBAPP_URL}?action=slots&fecha=${encodeURIComponent(fecha)}`);
    if (!res.ok) { show(`Error slots: ${res.status} ${res.statusText}`); return; }
    const data = await res.json();
    if (!data.ok) { show(data.error || 'No se pudieron cargar los horarios'); return; }
    if (!data.slots.length) { $('slots').innerHTML = 'No hay horarios libres'; return; }

    $('slots').innerHTML = data.slots.map(h =>
      `<label style="display:inline-block;margin:6px 10px 0 0">
        <input type="radio" name="hora" value="${h}"> ${h}
      </label>`
    ).join('');

    document.querySelectorAll('input[name="hora"]').forEach(r => {
      r.onchange = () => { horaElegida = r.value; show('Horario elegido: ' + horaElegida, true); };
    });
  } catch (e) {
    show('Error de red al cargar horarios'); 
  }
};

$('btnSend').onclick = async () => {
  show('');
  const fecha = $('fecha').value.trim();
  const nombre = $('nombre').value.trim();
  const telefono = $('tel').value.trim();
  const direccion = $('dir').value.trim();
  const servicio = $('serv').value.split(' – ')[0];

  if (!fecha || !horaElegida || !nombre || !telefono || !direccion) {
    show('Completá fecha, horario, nombre, teléfono y dirección');
    return;
  }

  try {
    const res = await fetch(WEBAPP_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ action:'create', fecha, hora:horaElegida, servicio, nombre, telefono, direccion })
    });
    if (!res.ok) { show(`Error al reservar: ${res.status} ${res.statusText}`); return; }
    const data = await res.json();
    if (data.ok) {
      show('✅ ¡Turno reservado! Te confirmamos por WhatsApp.', true);
      // Limpio selección de hora
      document.querySelectorAll('input[name="hora"]').forEach(r => r.checked = false);
      horaElegida = '';
    } else {
      show(data.error || 'No se pudo reservar');
    }
  } catch (e) {
    show('Error de red al reservar');
  }
};
</script>

