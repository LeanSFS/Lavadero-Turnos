<!doctype html>
<html lang="es">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Lavado a Domicilio ‚Äì Reservas</title>
<style>
  :root{--bg:#0f172a;--card:#0b1220;--line:#1f2937;--muted:#9ca3af;--ok:#22c55e}
  body{font-family:system-ui,Arial;background:var(--bg);color:#fff;margin:0;padding:24px}
  .box{max-width:720px;margin:0 auto;background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px}
  h1{margin:0 0 8px;font-size:22px}
  .muted{color:var(--muted);margin:0 0 16px}
  label{display:block;margin:12px 0 6px}
  select,input{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#0f172a;color:#fff}
  .slots{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 16px}
  .slot{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#111827;color:#e5e7eb;cursor:pointer}
  .slot.sel{outline:2px solid var(--ok)}
  button{padding:12px 14px;border-radius:10px;border:1px solid var(--ok);background:var(--ok);color:#0b1220;font-weight:700;cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed;pointer-events:none}
  .msg{margin-top:10px;color:var(--muted);white-space:pre-wrap}
</style>

<div class="box">
  <h1>Lavado a Domicilio üöó‚ú®</h1>
  <p class="muted">Eleg√≠ el d√≠a, el horario disponible y el servicio. Te confirmamos por WhatsApp.</p>

  <label for="dia">D√≠a (pr√≥ximos 14)</label>
  <select id="dia"><option value="">Cargando d√≠as‚Ä¶</option></select>

  <div id="bloque-slots" style="display:none">
    <div class="muted" id="subfecha"></div>
    <div id="slots" class="slots"></div>
  </div>

  <label>Nombre y Apellido</label>
  <input id="nombre" placeholder="Juan P√©rez">
  <label>Tel√©fono</label>
  <input id="telefono" placeholder="2994...">
  <label>Direcci√≥n</label>
  <input id="direccion" placeholder="Calle y n√∫mero, barrio">
  <label>Servicio</label>
  <select id="servicio">
    <option value="Exterior">Exterior ‚Äì $15.000</option>
    <option value="Interior">Interior ‚Äì $15.000</option>
    <option value="Completo">Completo ‚Äì $20.000</option>
    <option value="Full">Full ‚Äì $30.000</option>
  </select>

  <div style="margin-top:14px">
    <button id="btn" type="button">Reservar</button>
  </div>
  <div id="msg" class="msg"></div>
</div>

<script>
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyDd--FDaQPnqG_LQ4MzLuRmIQc99Y0WK1Axpwh3Tc4GX1DLCHn77XTr2-wBZUVCuVO/exec';

const $dia = document.getElementById('dia');
const $slots = document.getElementById('slots');
const $sub = document.getElementById('subfecha');
const $bloque = document.getElementById('bloque-slots');
const $msg = document.getElementById('msg');

const S = { map:new Map(), selFecha:null, selHora:null };

const pad = n => String(n).padStart(2,'0');
function niceFecha(iso){
  const [y,m,d]=iso.split('-').map(Number);
  const dt=new Date(y,(m||1)-1,d);
  const dias=['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
  return `${dias[dt.getDay()]} ${pad(d)}/${pad(m)}`;
}

async function cargarDias(){
  $msg.textContent = 'Cargando disponibilidad‚Ä¶';
  try{
    const r = await fetch(`${WEBAPP_URL}?action=slots14&days=14&t=${Date.now()}`);
    const j = await r.json();
    if (!j.ok || !Array.isArray(j.rows)) throw new Error(j.error||'Respuesta inv√°lida');

    $dia.innerHTML = '<option value="">Eleg√≠ un d√≠a‚Ä¶</option>' +
      j.rows.map(d => {
        const libres = (d.count ?? (d.slots? d.slots.length : 0));
        return `<option value="${d.fecha}">${niceFecha(d.fecha)} ‚Äî ${libres} libres</option>`;
      }).join('');

    S.map = new Map(j.rows.map(x => [x.fecha, x.slots]));
    $msg.textContent = '';
  }catch(e){
    console.error(e);
    $msg.textContent = '‚ö†Ô∏è No se pudieron cargar los d√≠as. ' + e.message;
  }
}

$dia.addEventListener('change', () => {
  S.selFecha = $dia.value || null;
  S.selHora = null;
  if (!S.selFecha){ $bloque.style.display='none'; return; }
  const libres = S.map.get(S.selFecha) || [];
  $sub.textContent = `Horarios disponibles para ${S.selFecha}`;
  $slots.innerHTML = libres.length
    ? libres.map(h => `<button class="slot" data-h="${h}">${h}</button>`).join('')
    : '<span class="muted">No hay horarios libres en este d√≠a.</span>';
  $bloque.style.display = 'block';
});

$slots.addEventListener('click', (ev) => {
  const b = ev.target.closest('.slot'); if(!b) return;
  S.selHora = b.dataset.h;
  [...$slots.querySelectorAll('.slot')].forEach(el => el.classList.toggle('sel', el===b));
});

let busy = false;
document.getElementById('btn').addEventListener('click', async () => {
  if (busy) return;
  $msg.textContent = '';

  const nombre = document.getElementById('nombre').value.trim();
  const telefono = document.getElementById('telefono').value.trim();
  const direccion = document.getElementById('direccion').value.trim();
  const servicio = document.getElementById('servicio').value;
  const btn = document.getElementById('btn');

  if (!S.selFecha || !S.selHora || !nombre || !telefono || !direccion){
    $msg.textContent = '‚ö†Ô∏è Complet√° todos los campos y eleg√≠ d√≠a y horario.'; 
    return;
  }

  try{
    busy = true;
    btn.disabled = true;
    btn.textContent = 'Reservando‚Ä¶';
    await new Promise(requestAnimationFrame); // fuerza repintado

    const qs = new URLSearchParams({
      action:'create',
      fecha:S.selFecha, hora:S.selHora, servicio,
      nombre, telefono, direccion
    });

    const res = await fetch(`${WEBAPP_URL}?${qs.toString()}`);
    const j = await res.json();
    if (!j.ok) throw new Error(j.error||'No se pudo reservar');

    const booking = { id:j.id, nombre, telefono, direccion, servicio,
                      fecha:S.selFecha, hora:S.selHora };
    sessionStorage.setItem('lastBooking', JSON.stringify(booking));

    location.href = 'success.html';
  }catch(e){
    $msg.textContent = '‚ö†Ô∏è ' + e.message;
    busy = false;
    btn.disabled = false;
    btn.textContent = 'Reservar';
  }
});

document.addEventListener('DOMContentLoaded', cargarDias);
</script>
</html>
