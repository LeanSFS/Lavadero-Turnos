<!doctype html>
<html lang="es">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Reserv√° tu turno ‚Äì Lavado a Domicilio</title>
<style>
  :root{--bg:#0f172a;--card:#111827;--muted:#9ca3af;--pri:#22c55e}
  body{font-family:system-ui,Arial;background:var(--bg);color:#fff;min-height:100vh;margin:0;display:flex;align-items:center;justify-content:center}
  .wrap{width:100%;max-width:700px;padding:20px}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:18px}
  h1{margin:0 0 10px;font-size:22px}
  p{margin:0 0 14px;color:var(--muted)}
  label{display:block;margin:8px 0 4px;color:#e5e7eb;font-size:14px}
  input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #374151;background:#0b1220;color:#fff}
  .btn{margin-top:10px;display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid #16a34a;background:#16a34a;color:#0b1220;font-weight:600;cursor:pointer}
  .btn.secondary{border-color:#374151;background:#111827;color:#e5e7eb}
  .row{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .chip{padding:8px 12px;border:1px solid #374151;border-radius:999px;background:#0b1220;color:#e5e7eb;cursor:pointer}
  .chip[disabled]{opacity:.35;cursor:not-allowed}
  .chip.sel{background:var(--pri);color:#0b1220;border-color:var(--pri);font-weight:700}
  .slots{margin-top:10px;display:flex;flex-wrap:wrap;gap:10px}
  .slot{padding:10px 14px;border:1px solid #374151;border-radius:10px;cursor:pointer}
  .slot.sel{background:var(--pri);color:#0b1220;border-color:var(--pri);font-weight:700}
  .msg{margin-top:10px;font-size:14px}
</style>

<div class="wrap">
  <div class="card">
    <h1>Lavado a Domicilio üöó‚ú®</h1>
    <p>Eleg√≠ fecha, horario disponible y servicio. Te confirmamos por WhatsApp.</p>

    <label>Fecha</label>
    <input type="date" id="fecha">

    <div class="row" id="quickDays"></div>

    <button class="btn secondary" id="btnSlots">Ver horarios disponibles</button>
    <div id="slots" class="slots"></div>

    <label>Nombre y Apellido</label>
    <input id="nombre" placeholder="Juan P√©rez">

    <label>Tel√©fono</label>
    <input id="tel" placeholder="2994...">

    <label>Direcci√≥n</label>
    <input id="dir" placeholder="Calle y n√∫mero, barrio">

    <label>Servicio</label>
    <select id="serv">
      <option>Exterior ‚Äì $15.000</option>
      <option>Interior ‚Äì $15.000</option>
      <option>Completo ‚Äì $20.000</option>
      <option>Encerado ‚Äì $12.000</option>
    </select>

    <button class="btn" id="btnSend">Reservar</button>
    <div id="msg" class="msg"></div>
  </div>
</div>

<script>
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzIdrsdl5F0OBXeDj7QbOCInq-vppixmdwevqXC6CnMoQREHHsL8eVz1keR3Lbc8P2yVg/exec';

const $ = (id) => document.getElementById(id);
let horaElegida = '';
let fechaElegida = '';

const dias = ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
function toISO(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
function labelDia(d){ return `${dias[d.getDay()]} ${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`; }

async function disponibilidad(fechaISO){
  try{
    const res = await fetch(`${WEBAPP_URL}?action=slots&fecha=${encodeURIComponent(fechaISO)}`);
    const data = await res.json();
    if (data && data.ok) return data.slots || [];
  }catch(e){}
  return [];
}

async function renderQuickDays(n=7){
  const cont = $('quickDays');
  cont.innerHTML = '';

  const hoy = new Date();
  hoy.setHours(0,0,0,0);
  $('fecha').min = toISO(hoy);         // no permite fechas pasadas
  $('fecha').value = $('fecha').value || toISO(hoy);
  fechaElegida = $('fecha').value;

  // Botones Hoy / Ma√±ana
  const manana = new Date(hoy); manana.setDate(hoy.getDate()+1);
  cont.appendChild(makeChip('Hoy', toISO(hoy)));
  cont.appendChild(makeChip('Ma√±ana', toISO(manana)));

  // Pr√≥ximos 7 d√≠as con cantidad de turnos libres
  for (let i=0;i<n;i++){
    const d = new Date(hoy); d.setDate(hoy.getDate()+i);
    const iso = toISO(d);
    const slots = await disponibilidad(iso);
    const chip = makeChip(`${labelDia(d)} (${slots.length})`, iso, slots.length===0);
    cont.appendChild(chip);
  }

  // marcar seleccionado si coincide
  marcarSeleccionFecha(fechaElegida);
}

function makeChip(text, iso, disabled=false){
  const el = document.createElement('button');
  el.className = 'chip';
  el.textContent = text;
  if (disabled) el.setAttribute('disabled','');
  el.onclick = async () => {
    if (disabled) return;
    $('fecha').value = iso;
    fechaElegida = iso;
    marcarSeleccionFecha(iso);
    await cargarSlots(); // carga horarios autom√°ticamente
  };
  el.dataset.iso = iso;
  return el;
}

function marcarSeleccionFecha(iso){
  document.querySelectorAll('#quickDays .chip').forEach(c => c.classList.remove('sel'));
  const match = Array.from(document.querySelectorAll('#quickDays .chip')).find(c => c.dataset.iso === iso);
  if (match) match.classList.add('sel');
}

async function cargarSlots(){
  $('msg').textContent = '';
  $('slots').innerHTML = '';
  const fecha = $('fecha').value;
  if (!fecha) { $('msg').textContent = 'Eleg√≠ una fecha'; $('msg').style.color='salmon'; return; }

  try{
    const res = await fetch(`${WEBAPP_URL}?action=slots&fecha=${encodeURIComponent(fecha)}`);
    if(!res.ok){ $('msg').textContent = 'Error al cargar horarios'; $('msg').style.color='salmon'; return; }
    const data = await res.json();
    if(!data.ok){ $('msg').textContent = data.error || 'Sin horarios'; $('msg').style.color='salmon'; return; }
    if(!data.slots.length){ $('slots').innerHTML = '<span style="color:#9ca3af">No hay horarios libres para ese d√≠a.</span>'; return; }

    horaElegida = '';
    $('slots').innerHTML = data.slots.map(h => `<span class="slot" data-h="${h}">${h}</span>`).join('');
    document.querySelectorAll('.slot').forEach(el => {
      el.onclick = () => {
        document.querySelectorAll('.slot').forEach(s=>s.classList.remove('sel'));
        el.classList.add('sel');
        horaElegida = el.dataset.h;
        $('msg').textContent = `Horario elegido: ${horaElegida}`;
        $('msg').style.color = '#22c55e';
      };
    });
  }catch(e){
    $('msg').textContent = 'Error de red'; $('msg').style.color='salmon';
  }
}

// Bot√≥n ‚ÄúVer horarios‚Äù
$('btnSlots').onclick = cargarSlots;

// Reservar
$('btnSend').onclick = async () => {
  $('msg').textContent = '';
  const fecha    = $('fecha').value;
  const nombre   = $('nombre').value.trim();
  const telefono = $('tel').value.trim();
  const direccion= $('dir').value.trim();
  const servicio = $('serv').value.split(' ‚Äì ')[0];

  if(!fecha || !horaElegida || !nombre || !telefono || !direccion){
    $('msg').textContent = 'Complet√° fecha, horario, nombre, tel√©fono y direcci√≥n.';
    $('msg').style.color='salmon';
    return;
  }

  // POST urlencoded (Apps Script lo toma en e.parameter)
  const params = new URLSearchParams();
  params.append('action','create');
  params.append('fecha', fecha);
  params.append('hora', horaElegida);
  params.append('servicio', servicio);
  params.append('nombre', nombre);
  params.append('telefono', telefono);
  params.append('direccion', direccion);

  try{
    const res  = await fetch(WEBAPP_URL, { method:'POST', body: params });
    const data = await res.json();
    if(data.ok){
      $('msg').textContent = '‚úÖ ¬°Turno reservado! Te confirmamos por WhatsApp.';
      $('msg').style.color = '#22c55e';
      $('slots').innerHTML = '';
      horaElegida = '';
      // Si quer√©s notificaci√≥n a tu WhatsApp, descoment√° y pon√© tu n√∫mero:
      // const texto = `Nuevo turno: ${nombre} (${telefono}) | ${servicio} | ${fecha} ${params.get('hora')} | ${direccion}`;
      // window.open(`https://wa.me/5492990000000?text=${encodeURIComponent(texto)}`, '_blank');
      // volver a recalcular chips (por si se agot√≥ ese d√≠a)
      renderQuickDays(7);
    } else {
      $('msg').textContent = data.error || 'No se pudo reservar.';
      $('msg').style.color='salmon';
    }
  }catch(e){
    $('msg').textContent = 'Error de red al reservar.'; 
    $('msg').style.color='salmon';
  }
};

// Inicial: setear hoy, min y dibujar chips
renderQuickDays(7);
</script>
</html>
