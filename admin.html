<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Agenda ‚Äì Admin</title>

  <style>
    :root{
      --bg:#0f172a;
      --card:#0b1220;
      --card2:#111827;
      --muted:#9ca3af;
      --pri:#22c55e;
      --line:#1f2937;
      --warn:#f59e0b;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,Arial;background:var(--bg);color:#fff;min-height:100vh;margin:0}
    .wrap{max-width:1280px;margin:0 auto;padding:24px}
    h1{margin:0 0 14px;font-size:28px}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
    .toolbar-spacer{flex:1 1 auto}
    input,select{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:#fff}
    button{padding:9px 12px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:#fff;font-weight:800;cursor:pointer}
    button:hover{filter:brightness(1.05)}
    button:disabled{opacity:.6;cursor:not-allowed}
    a.btn{display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid #16a34a;background:#16a34a;color:#0b1220;font-weight:900;text-decoration:none}
    a.btn:hover{filter:brightness(1.05)}

    #msg{margin:10px 0;color:var(--muted);white-space:pre-wrap}

    /* ====== Calendario 2 semanas ====== */
    .calWrap{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
    }
    .calTop{
      display:flex; gap:10px; align-items:center;
      padding:12px;
      background:rgba(0,0,0,.18);
      border-bottom:1px solid var(--line);
    }
    .calTitle{font-weight:950;letter-spacing:.2px}
    .calNav{display:flex;gap:8px;align-items:center}
    .ghost{background:transparent}

    /* ‚úÖ M√°s ancho: columnas y tarjetas m√°s c√≥modas */
    .calGrid{
      display:grid;
      grid-template-columns: repeat(14, minmax(360px, 1fr));
      gap:0;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      background:var(--card2);
    }

    .dayCol{border-right:1px solid var(--line);min-height:380px}
    .dayCol:last-child{border-right:none}
    .dayHead{
      position:sticky; top:0; z-index:2;
      padding:10px 10px 8px;
      background:var(--card);
      border-bottom:1px solid var(--line);
    }
    .dayHead .dow{font-size:12px;color:var(--muted);font-weight:900}
    .dayHead .date{font-size:14px;font-weight:950;margin-top:2px}
    .dayHead .meta{font-size:11px;color:var(--muted);margin-top:2px}
    .dayBody{padding:10px;display:flex;flex-direction:column;gap:10px}

    /* ====== Tarjeta ====== */
    .slotCard{
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow:0 10px 26px rgba(0,0,0,.25);
    }

    .cardHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .titleBlock{display:flex;flex-direction:column;gap:8px;min-width:0;width:100%}

    .topLine{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .hora{font-weight:950;font-size:14px;letter-spacing:.2px}

    .chip{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      display:inline-flex;
      align-items:center;
      font-size:12px;
      font-weight:950;
      white-space:nowrap;
    }
    .chip.pendiente{border-color:#64748b;color:#e5e7eb}
    .chip.confirmado{border-color:var(--pri);background:rgba(34,197,94,.14);color:#bbf7d0}
    .chip.hecho{border-color:#38bdf8;background:rgba(56,189,248,.12);color:#bae6fd}
    .chip.cancelado{border-color:var(--danger);background:rgba(239,68,68,.12);color:#fecaca}

    .srv{font-weight:950;font-size:15px;margin:0}
    .client{font-weight:950;font-size:15px}

    .sub{font-size:13px;color:var(--muted);line-height:1.35}

    /* ‚úÖ Direcci√≥n legible (no rompe palabras en 3 letras) */
    .addr{
      white-space: normal;
      overflow-wrap: break-word;
      word-break: normal;
      line-height: 1.35;
    }

    .badgeRow{display:flex;gap:8px;align-items:center;flex-shrink:0}

    a.whats{
      padding:8px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--card);
      color:#e5e7eb;
      text-decoration:none;
      font-weight:950;
      font-size:12px;
      line-height:1;
      white-space:nowrap;
    }
    a.whats:hover{filter:brightness(1.06)}

    /* ====== Men√∫ desplegable acciones ====== */
    .menuWrap{position:relative;display:inline-block}
    .menuBtn{
      padding:8px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:#fff;
      font-weight:950;
      cursor:pointer;
      white-space:nowrap;
    }
    .menuBtn:hover{filter:brightness(1.06)}
    .menu{
      position:absolute;
      right:0;
      top:calc(100% + 8px);
      min-width:220px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      box-shadow:0 18px 40px rgba(0,0,0,.45);
      padding:6px;
      display:none;
      z-index:50;
    }
    .menu.open{display:block}
    .menuItem{
      width:100%;
      text-align:left;
      border:1px solid transparent;
      background:transparent;
      color:#fff;
      padding:10px 10px;
      border-radius:12px;
      font-weight:950;
      cursor:pointer;
      white-space:nowrap;
    }
    .menuItem:hover{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.06)}
    .menuItem.ok{color:#bbf7d0}
    .menuItem.warn{color:#fde68a}
    .menuItem.danger{color:#fecaca}

    .empty{
      border:1px dashed rgba(148,163,184,.35);
      border-radius:14px;
      padding:10px;
      color:rgba(148,163,184,.9);
      font-size:12px;
      text-align:center;
    }

    .footerBar{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:10px;color:var(--muted)}
  </style>
</head>

<body>
<div class="wrap">
  <h1>Agenda ‚Äì Admin</h1>

  <div class="toolbar">
    <label>Inicio <input type="date" id="f-fecha"></label>

    <label>Estado
      <select id="f-estado">
        <option value="">(todos)</option>
        <option value="pendiente">pendiente</option>
        <option value="confirmado">confirmado</option>
        <option value="hecho">hecho</option>
        <option value="cancelado">cancelado</option>
      </select>
    </label>

    <input id="f-q" placeholder="Buscar (cliente / dir / tel)" style="flex:1 1 320px">
    <button id="btnReload" class="ok" type="button">Actualizar</button>

    <span class="toolbar-spacer"></span>
    <a href="caja.html" class="btn" id="btnCaja" target="_self" title="Ir a Caja (registro econ√≥mico)">üíµ Ir a Caja</a>
  </div>

  <div id="msg"></div>

  <div class="calWrap">
    <div class="calTop">
      <div class="calNav">
        <button id="btnPrev" class="ghost" type="button">‚Üê</button>
        <button id="btnToday" class="ghost" type="button">Hoy</button>
        <button id="btnNext" class="ghost" type="button">‚Üí</button>
      </div>
      <div class="calTitle" id="rangeTitle"></div>
      <div class="toolbar-spacer"></div>
      <div class="sub" style="max-width:420px">Tip: scrol horizontal para ver las 2 semanas completas.</div>
    </div>

    <div id="calGrid" class="calGrid"></div>
  </div>

  <div class="footerBar">
    <div id="count"></div>
    <div class="sub" id="hint"></div>
  </div>
</div>

<script>
  // TU WebApp
  const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyDd--FDaQPnqG_LQ4MzLuRmIQc99Y0WK1Axpwh3Tc4GX1DLCHn77XTr2-wBZUVCuVO/exec';

  const state = { rows: [], startISO: '' };
  const pad = n => String(n).padStart(2,'0');

  function isoFromDate(dt){ return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`; }
  function dateFromISO(iso){ const [y,m,d]=(iso||'').split('-').map(Number); return new Date(y,(m||1)-1,d||1); }
  function addDays(dt,n){ const x=new Date(dt); x.setDate(x.getDate()+n); x.setHours(0,0,0,0); return x; }

  function niceFechaShort(iso){
    const dt = dateFromISO(iso);
    const dias=['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
    return `${dias[dt.getDay()]} ${pad(dt.getDate())}/${pad(dt.getMonth()+1)}`;
  }
  function niceRangeTitle(startISO){
    const a = dateFromISO(startISO);
    const b = addDays(a, 13);
    return `${niceFechaShort(isoFromDate(a))}  ‚Üí  ${niceFechaShort(isoFromDate(b))}`;
  }

  function setMsg(t, isErr=false){
    const el=document.getElementById('msg');
    el.textContent=t||'';
    el.style.color=isErr?'#fca5a5':'#9ca3af';
  }
  function setStart(iso){
    state.startISO = iso;
    document.getElementById('f-fecha').value = iso;
    document.getElementById('rangeTitle').textContent = niceRangeTitle(iso);
  }

  function cleanPhone(p){ return String(p||'').replace(/[^0-9+]/g,''); }
  function esc(s){
    return String(s||'')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  async function load(){
    try{
      setMsg('Cargando‚Ä¶');
      const r = await fetch(`${WEBAPP_URL}?action=list&t=${Date.now()}`);
      const j = await r.json();
      if (!j.ok) throw new Error(j.error||'Error al listar');
      state.rows = j.rows || [];
      render();
      setMsg('');
    }catch(e){
      setMsg('‚ö†Ô∏è '+e.message,true);
      console.error(e);
    }
  }

  function getFilteredRows(){
    const fEstado = document.getElementById('f-estado').value.trim().toLowerCase();
    const fQ = document.getElementById('f-q').value.trim().toLowerCase();
    let rows = state.rows.slice();

    if (fEstado) rows = rows.filter(r => (r.estado||'').toLowerCase() === fEstado);
    if (fQ){
      rows = rows.filter(r =>
        (r.nombre||'').toLowerCase().includes(fQ) ||
        (r.direccion||'').toLowerCase().includes(fQ) ||
        (r.telefono||'').toLowerCase().includes(fQ)
      );
    }
    return rows;
  }

  function cardHTML(r){
    const estado = (r.estado||'').toLowerCase();
    const chipCls = ['pendiente','confirmado','hecho','cancelado'].includes(estado) ? estado : '';
    const telClean = cleanPhone(r.telefono);

    // ‚úÖ Direcci√≥n con saltos de l√≠nea en comas
    const dirHTML = r.direccion ? esc(r.direccion).replace(/,\s*/g,'<br>') : '';

    return `
      <div class="slotCard">
        <div class="cardHeader">
          <div class="titleBlock">
            <div class="topLine">
              <div class="hora">${esc(r.hora||'‚Äî')}</div>
              <span class="chip ${chipCls}">${esc(r.estado||'‚Äî')}</span>
            </div>

            <div class="srv">${esc(r.servicio||'Servicio')}</div>
            <div class="client">${esc(r.nombre||'Cliente')}</div>

            ${r.direccion ? `<div class="sub addr">${dirHTML}</div>` : ``}
            ${r.telefono ? `<div class="sub">üìû ${esc(r.telefono)}</div>` : ``}
          </div>

          <div class="badgeRow">
            <a class="whats" href="https://wa.me/${telClean}" target="_blank" rel="noopener">WhatsApp</a>

            <div class="menuWrap">
              <button class="menuBtn" type="button" data-act="menu" data-id="${encodeURIComponent(r.id)}">
                Acciones ‚ñæ
              </button>

              <div class="menu" data-menu-for="${encodeURIComponent(r.id)}">
                <button class="menuItem ok" type="button" data-act="status" data-estado="confirmado" data-id="${encodeURIComponent(r.id)}">‚úÖ Confirmar</button>
                <button class="menuItem ok" type="button" data-act="status" data-estado="hecho" data-id="${encodeURIComponent(r.id)}">üèÅ Marcar Hecho</button>
                <button class="menuItem warn" type="button" data-act="status" data-estado="cancelado" data-id="${encodeURIComponent(r.id)}">‚ö†Ô∏è Cancelar</button>
                <button class="menuItem danger" type="button" data-act="delete"
                  data-id="${encodeURIComponent(r.id)}"
                  data-fecha="${encodeURIComponent(r.fecha)}"
                  data-hora="${encodeURIComponent(r.hora)}">üóëÔ∏è Borrar</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function closeAllMenus(){
    document.querySelectorAll('.menu.open').forEach(m => m.classList.remove('open'));
  }

  function render(){
    try{
      const calGrid = document.getElementById('calGrid');

      const startISO = document.getElementById('f-fecha').value || state.startISO;
      if (startISO && startISO !== state.startISO) setStart(startISO);

      const start = dateFromISO(state.startISO);
      const end = addDays(start, 14);
      const startT = start.getTime();
      const endT = end.getTime();

      const rows = getFilteredRows().filter(r => {
        if (!r.fecha) return false;
        const t = dateFromISO(r.fecha).getTime();
        return t >= startT && t < endT;
      });

      rows.sort((a,b) => (a.fecha||'').localeCompare(b.fecha||'') || (a.hora||'').localeCompare(b.hora||''));

      document.getElementById('count').textContent = `${rows.length} turno(s) en estas 2 semanas`;
      document.getElementById('hint').textContent = rows.length ? 'Acciones dentro de cada tarjeta.' : '';

      const byDate = new Map();
      for (const r of rows){
        if (!byDate.has(r.fecha)) byDate.set(r.fecha, []);
        byDate.get(r.fecha).push(r);
      }

      const cols = [];
      for (let i=0;i<14;i++){
        const d = addDays(start, i);
        const iso = isoFromDate(d);
        const list = byDate.get(iso) || [];

        const dias=['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
        const headDow = dias[d.getDay()];
        const headDate = `${pad(d.getDate())}/${pad(dt.getMonth()+1)}/${d.getFullYear()}`;

        cols.push(`
          <div class="dayCol" data-day="${iso}">
            <div class="dayHead">
              <div class="dow">${headDow}</div>
              <div class="date">${headDate}</div>
              <div class="meta">${list.length} turno(s)</div>
            </div>
            <div class="dayBody">
              ${list.length ? list.map(cardHTML).join('') : `<div class="empty">Sin turnos</div>`}
            </div>
          </div>
        `);
      }

      calGrid.innerHTML = cols.join('');
      closeAllMenus();
    }catch(e){
      console.error(e);
      setMsg('‚ö†Ô∏è Render error: ' + e.message, true);
    }
  }

  // Cerrar men√∫s clickeando afuera
  document.addEventListener('click', (ev) => {
    const insideMenu = ev.target.closest('.menuWrap');
    if (!insideMenu) closeAllMenus();
  });

  // Delegaci√≥n de eventos: men√∫ + acciones
  document.addEventListener('click', async (ev) => {
    const el = ev.target.closest('button');
    if (!el) return;

    const act = el.dataset.act;
    if (!act) return;

    try{
      if (act === 'menu'){
        const id = el.dataset.id || '';
        const menu = document.querySelector(`.menu[data-menu-for="${CSS.escape(id)}"]`);
        if (!menu) return;
        const isOpen = menu.classList.contains('open');
        closeAllMenus();
        if (!isOpen) menu.classList.add('open');
        return;
      }

      closeAllMenus();
      el.disabled = true;

      if (act === 'status') {
        const id = decodeURIComponent(el.dataset.id||'');
        const estado = el.dataset.estado || '';
        const url = `${WEBAPP_URL}?action=status&id=${encodeURIComponent(id)}&estado=${encodeURIComponent(estado)}&t=${Date.now()}`;
        const res = await fetch(url);
        const data = await res.json();
        if (!data.ok) { setMsg(`‚ö†Ô∏è ${data.error||'Error al cambiar estado'}`, true); return; }
        await load(); return;
      }

      if (act === 'delete') {
        if (!confirm('¬øBorrar definitivamente este turno?')) return;

        const id  = decodeURIComponent(el.dataset.id||'');
        const f   = decodeURIComponent(el.dataset.fecha||'');
        const h   = decodeURIComponent(el.dataset.hora||'');

        const url = `${WEBAPP_URL}?action=delete&id=${encodeURIComponent(id)}&fecha=${encodeURIComponent(f)}&hora=${encodeURIComponent(h)}&t=${Date.now()}`;
        const res = await fetch(url);
        const data = await res.json();
        if (!data.ok) { setMsg(`‚ö†Ô∏è Error al borrar: ${data.error}`, true); return; }
        setMsg('‚úÖ Borrado OK');
        await load(); return;
      }
    }catch(e){
      setMsg('‚ö†Ô∏è '+e.message,true);
      console.error(e);
    }finally{
      el.disabled = false;
    }
  });

  // Navegaci√≥n 2 semanas
  document.getElementById('btnPrev').onclick = () => {
    const s = dateFromISO(state.startISO);
    setStart(isoFromDate(addDays(s, -14)));
    render();
  };
  document.getElementById('btnNext').onclick = () => {
    const s = dateFromISO(state.startISO);
    setStart(isoFromDate(addDays(s, 14)));
    render();
  };
  document.getElementById('btnToday').onclick = () => {
    const today = new Date(); today.setHours(0,0,0,0);
    setStart(isoFromDate(today));
    render();
  };

  document.getElementById('btnReload').onclick = load;
  document.getElementById('f-fecha').onchange = () => { setStart(document.getElementById('f-fecha').value); render(); };
  document.getElementById('f-estado').onchange =
  document.getElementById('f-q').oninput = render;

  // inicio: hoy
  const today = new Date(); today.setHours(0,0,0,0);
  setStart(isoFromDate(today));
  load();
</script>
</body>
</html>
