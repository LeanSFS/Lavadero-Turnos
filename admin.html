<!doctype html>
<html lang="es">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Agenda – Admin</title>
<style>
  :root{--bg:#0f172a;--card:#111827;--muted:#9ca3af;--pri:#22c55e;--line:#1f2937}
  body{font-family:system-ui,Arial;background:var(--bg);color:#fff;min-height:100vh;margin:0}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  h1{margin:0 0 14px;font-size:28px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
  input,select{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:#fff}
  button{padding:10px 14px;border-radius:10px;border:1px solid #16a34a;background:#16a34a;color:#0b1220;font-weight:600;cursor:pointer}
  table{width:100%;border-collapse:collapse;background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden}
  th,td{padding:12px;border-bottom:1px solid var(--line);vertical-align:top}
  th{background:#0b1220;text-align:left}
  tr:last-child td{border-bottom:none}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--line);display:inline-block}
  a.whats{padding:8px 10px;border-radius:8px;border:1px solid var(--line);background:#0b1220;color:#e5e7eb;text-decoration:none}
  .muted{color:#9ca3af}
  .ok{border-color:#22c55e;background:#22c55e;color:#0b1220}
  .warn{border-color:#f59e0b;background:#f59e0b;color:#0b1220}
  .danger{border-color:#ef4444;background:#ef4444;color:#0b1220}
  .tiny{font-size:11px;color:#9ca3af}
  #msg{margin:10px 0;color:#9ca3af;white-space:pre-wrap}
  .actions{display:flex;flex-wrap:wrap;gap:6px}
</style>

<div class="wrap">
  <h1>Agenda – Admin</h1>
  <div class="toolbar">
    <label>Fecha <input type="date" id="f-fecha"></label>
    <label>Estado
      <select id="f-estado">
        <option value="">(todos)</option>
        <option value="pendiente">pendiente</option>
        <option value="confirmado">confirmado</option>
        <option value="hecho">hecho</option>
        <option value="cancelado">cancelado</option>
      </select>
    </label>
    <input id="f-q" placeholder="Buscar (cliente / dir / tel)" style="flex:1 1 320px">
    <button id="btnReload" class="ok" type="button">Actualizar</button>
  </div>

  <div id="msg"></div>

  <table id="tbl">
    <thead>
      <tr>
        <th>Fecha</th><th>Hora</th><th>Servicio</th><th>Cliente</th>
        <th>Teléfono</th><th>Dirección</th><th>Estado</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="muted" id="count" style="margin-top:8px"></div>
</div>

<script>
// TU WebApp (el que me pasaste)
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyDd--FDaQPnqG_LQ4MzLuRmIQc99Y0WK1Axpwh3Tc4GX1DLCHn77XTr2-wBZUVCuVO/exec';

const state = { rows: [] };
const pad = n => String(n).padStart(2,'0');
function niceFecha(iso){ if(!iso) return ''; const [y,m,d]=iso.split('-').map(Number); const dt=new Date(y,(m||1)-1,d||1); const dias=['Dom','Lun','Mar','Mié','Jue','Vie','Sáb']; return `${dias[dt.getDay()]} ${pad(dt.getDate())}/${pad(dt.getMonth()+1)}/${pad(dt.getFullYear())}`; }
function setMsg(t, isErr=false){ const el=document.getElementById('msg'); el.textContent=t||''; el.style.color=isErr?'#fca5a5':'#9ca3af'; }

async function load(){
  try{
    setMsg('Cargando…');
    const r = await fetch(`${WEBAPP_URL}?action=list&t=${Date.now()}`);
    const j = await r.json();
    if (!j.ok) throw new Error(j.error||'Error al listar');
    state.rows = j.rows || [];
    render();
    setMsg('');
  }catch(e){ setMsg('⚠️ '+e.message,true); console.error(e); }
}

function render(){
  const tbody = document.getElementById('tbody');
  const fFecha  = document.getElementById('f-fecha').value;
  const fEstado = document.getElementById('f-estado').value.trim().toLowerCase();
  const fQ      = document.getElementById('f-q').value.trim().toLowerCase();

  const rows = state.rows.filter(r =>
    (!fFecha || r.fecha === fFecha) &&
    (!fEstado || (r.estado||'').toLowerCase() === fEstado) &&
    (!fQ || (
      (r.nombre||'').toLowerCase().includes(fQ) ||
      (r.direccion||'').toLowerCase().includes(fQ) ||
      (r.telefono||'').toLowerCase().includes(fQ)
    ))
  );

  document.getElementById('count').textContent = `${rows.length} turno(s) mostrados`;
  if (!rows.length){ tbody.innerHTML = `<tr><td colspan="8" class="muted">Sin datos</td></tr>`; return; }

  tbody.innerHTML = rows.map(r => `
    <tr>
      <td>${niceFecha(r.fecha)}<div class="tiny">ID: ${r.id}</div></td>
      <td>${r.hora}</td>
      <td>${r.servicio}</td>
      <td>${r.nombre}</td>
      <td><a class="whats" href="https://wa.me/${(r.telefono||'').replace(/[^0-9+]/g,'')}" target="_blank">${r.telefono||''}</a></td>
      <td>${r.direccion}</td>
      <td><span class="chip">${r.estado}</span></td>
      <td class="actions">
        <button class="ok"   type="button" data-act="status" data-estado="confirmado" data-id="${encodeURIComponent(r.id)}">Confirmar</button>
        <button class="ok"   type="button" data-act="status" data-estado="hecho"       data-id="${encodeURIComponent(r.id)}">Hecho</button>
        <button class="warn" type="button" data-act="status" data-estado="cancelado"   data-id="${encodeURIComponent(r.id)}">Cancelar</button>
        <button class="danger" type="button" data-act="delete"
                data-id="${encodeURIComponent(r.id)}"
                data-fecha="${encodeURIComponent(r.fecha)}"
                data-hora="${encodeURIComponent(r.hora)}">Borrar</button>
      </td>
    </tr>
  `).join('');
}

/* Delegación de eventos con debug visible */
document.getElementById('tbody').addEventListener('click', async (ev) => {
  const btn = ev.target.closest('button'); if (!btn) return;
  const act = btn.dataset.act; if (!act) return;
  btn.disabled = true;

  try{
    if (act === 'status') {
      const id = decodeURIComponent(btn.dataset.id||'');
      const estado = btn.dataset.estado || '';
      const url = `${WEBAPP_URL}?action=status&id=${encodeURIComponent(id)}&estado=${encodeURIComponent(estado)}&t=${Date.now()}`;
      const res = await fetch(url); const data = await res.json();
      if (!data.ok) { setMsg(`⚠️ ${data.error||'Error al cambiar estado'}`, true); return; }
      await load(); return;
    }

    if (act === 'delete') {
      if (!confirm('¿Borrar definitivamente este turno?')) return;
      const id  = decodeURIComponent(btn.dataset.id||'');
      const f   = decodeURIComponent(btn.dataset.fecha||'');
      const h   = decodeURIComponent(btn.dataset.hora||'');

      const url = `${WEBAPP_URL}?action=delete&id=${encodeURIComponent(id)}&fecha=${encodeURIComponent(f)}&hora=${encodeURIComponent(h)}&t=${Date.now()}`;
      console.log('DELETE URL ->', url);
      const res = await fetch(url);
      const data = await res.json();
      if (!data.ok) { setMsg(`⚠️ Error al borrar: ${data.error}`, true); return; }
      setMsg(`✅ Borrado OK (vía ${data.via||'?'}, fila ${data.row||'?'})`);
      await load(); return;
    }
  }catch(e){ setMsg('⚠️ '+e.message,true); console.error(e); }
  finally{ btn.disabled = false; }
});

document.getElementById('btnReload').onclick = load;
document.getElementById('f-fecha').onchange =
document.getElementById('f-estado').onchange =
document.getElementById('f-q').oninput = render;

load();
</script>
</html>
