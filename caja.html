<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LyS Lavados — Admin Caja</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <style>
    :root{ --bg:#0f172a; --card:#0b1220; --line:#1f2937; --muted:#9ca3af; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444 }
    html,body{height:100%}
    body{ margin:0; background:var(--bg); color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif }
    .wrap{ max-width:1100px; margin:0 auto; padding:24px }
    .box{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:18px }

    h1{ margin:0 0 16px; font-size:22px }
    h2{ margin:0 0 10px; font-size:18px }
    .muted{ color:var(--muted) }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .grid{ display:grid; gap:12px }
    .grid.cols-4{ grid-template-columns: repeat(4, minmax(0,1fr)); }
    .grid.cols-3{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    .grid.cols-2{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:4px }

    input, select, textarea{
      width:100%; padding:10px 12px; border-radius:10px;
      border:1px solid var(--line); background:#0f172a; color:#fff; box-sizing:border-box
    }
    button{ padding:10px 14px; border-radius:10px; border:1px solid var(--line); background:#111827; color:#e5e7eb; cursor:pointer }
    button.primary{ border-color:var(--ok); background:var(--ok); color:#0b1220; font-weight:800 }
    button.warn{ border-color:var(--warn); background:var(--warn); color:#0b1220; font-weight:700 }
    button.ghost{ background:#0f172a }
    button:disabled{ opacity:.6; cursor:not-allowed }
    .toolbar{ display:flex; gap:10px; align-items:flex-end; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap }

    /* Quick ranges */
    .quickbar{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn-filter{ background:#111827; border:1px solid var(--line); color:#e5e7eb; padding:8px 12px; border-radius:10px; }
    .btn-filter.active{ background:var(--ok); color:#0b1220; border-color:var(--ok); font-weight:800 }

    .cards3{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px; margin:10px 0 14px }
    .card{ background:#111827; border:1px solid var(--line); border-radius:12px; padding:12px }
    .card h3{ margin:0 0 6px; font-size:13px; color:var(--muted) }
    .card .num{ font-weight:800; font-size:20px }

    table{ width:100%; border-collapse:collapse }
    th, td{ border-bottom:1px solid var(--line); padding:10px; text-align:left; vertical-align:top }
    th{ color:#e5e7eb; font-weight:700; font-size:12px; position:sticky; top:0; background:#0f172a }
    tr:hover td{ background:#0f172a }
    .right{ text-align:right }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line); background:#0f172a }
    .pill.ok{ background:rgba(34,197,94,.12); border-color:#1b6d3b }
    .pill.bad{ background:rgba(239,68,68,.12); border-color:#7a2222 }
    .pill.warn{ background:rgba(245,158,11,.12); border-color:#8a5a10 }

    .section{ margin-top:18px }
    .msg{ margin-top:8px; color:var(--muted); white-space:pre-wrap }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0 }

    /* Responsive -> tabla a cards */
    @media (max-width:900px){
      .grid.cols-4{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      .cards3{ grid-template-columns:1fr }
    }
    @media (max-width:700px){
      table{ display:none }
      .cards-list{ display:grid; gap:10px }
      .card-row{ background:#111827; border:1px solid var(--line); border-radius:12px; padding:12px }
      .card-row .line{ display:flex; justify-content:space-between; gap:12px; margin:4px 0 }
      .card-row .label{ color:var(--muted); font-size:12px }
    }
    @media (min-width:701px){
      .cards-list{ display:none }
    }

    /* Modal simple */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; padding:20px }
    .modal .panel{ background:var(--card); border:1px solid var(--line); border-radius:12px; padding:16px; max-width:420px; width:100% }
  </style>
</head>
<body>
  <main class="wrap">
    <div class="box">
      <h1>Gestión — Caja (Ingresos / Gastos)</h1>

      <!-- FILTROS -->
      <div class="section">
        <div class="toolbar" style="flex-direction:column; align-items:stretch; gap:12px">
          <!-- Fila 1: Fechas + Tipo + Estado -->
          <div class="grid cols-4" style="min-width:280px">
            <div>
              <label for="f_from">Desde</label>
              <input type="date" id="f_from" />
            </div>
            <div>
              <label for="f_to">Hasta</label>
              <input type="date" id="f_to" />
            </div>
            <div>
              <label for="f_tipo">Tipo</label>
              <select id="f_tipo"><option value="">Todos</option><option value="Ingreso">Ingreso</option><option value="Gasto">Gasto</option></select>
            </div>
            <div>
              <label for="f_estado">Estado</label>
              <select id="f_estado"><option value="">Todos</option><option value="Pagado">Pagado</option><option value="Pendiente">Pendiente</option></select>
            </div>
          </div>

          <!-- Fila 2: Medio + Categoría -->
          <div class="grid cols-2" style="min-width:280px">
            <div>
              <label for="f_medio">Medio</label>
              <select id="f_medio"><option value="">Todos</option><option value="Efectivo">Efectivo</option><option value="Transferencia">Transferencia</option></select>
            </div>
            <div>
              <label for="f_categoria">Categoría</label>
              <select id="f_categoria"><option value="">Todas</option></select>
            </div>
          </div>

          <!-- Fila 3: Rango rápido + Acciones -->
          <div class="row" style="justify-content:space-between; gap:10px">
            <div class="quickbar" id="quickbar">
              <button type="button" class="btn-filter" data-range="hoy"  id="btn_period_hoy">Hoy</button>
              <button type="button" class="btn-filter" data-range="ayer" id="btn_period_ayer">Ayer</button>
              <button type="button" class="btn-filter" data-range="semana" id="btn_period_semana">Esta semana</button>
              <button type="button" class="btn-filter" data-range="mes"   id="btn_period_mes">Este mes</button>
              <button type="button" class="btn-filter" data-range="todo"  id="btn_period_todo">Todo</button>
            </div>
            <div class="row" style="gap:8px">
              <button class="primary" id="btn_buscar">Buscar</button>
              <button class="ghost" id="btn_export">Exportar CSV</button>
            </div>
          </div>
        </div>
        <div id="list_msg" class="msg"></div>
      </div>

      <!-- CARDS TOTALES -->
      <div class="cards3">
        <div class="card"><h3>Ingresos</h3><div class="num" id="k_ingresos">$ 0</div></div>
        <div class="card"><h3>Gastos</h3><div class="num" id="k_gastos">$ 0</div></div>
        <div class="card"><h3>Neto</h3><div class="num" id="k_neto">$ 0</div></div>
      </div>

      <!-- TABLA (desktop) -->
      <div class="section">
        <div class="box" style="background:#0f172a; border-radius:12px">
          <table id="tabla">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Categoría</th>
                <th>Concepto</th>
                <th class="right">Monto</th>
                <th>Medio</th>
                <th>Estado</th>
                <th>Factura</th>
                <th>Cliente</th>
                <th class="right"></th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
          <!-- Cards (mobile) -->
          <div id="cards_list" class="cards-list"></div>
        </div>
      </div>

      <!-- ALTA RÁPIDA -->
      <div class="section">
        <h2>Agregar movimiento</h2>
        <div class="grid cols-4">
          <div>
            <label for="a_fecha">Fecha</label>
            <input type="date" id="a_fecha" />
          </div>
          <div>
            <label for="a_tipo">Tipo</label>
            <select id="a_tipo"><option value="Ingreso">Ingreso</option><option value="Gasto">Gasto</option></select>
          </div>
          <div>
            <label for="a_categoria">Categoría</label>
            <select id="a_categoria"></select>
          </div>
          <div id="a_categoria_otro_wrap" style="display:none">
            <label for="a_categoria_otro">Otra categoría</label>
            <input id="a_categoria_otro" placeholder="Especificar" />
          </div>

          <div class="colspan">
            <label for="a_concepto">Concepto</label>
            <input id="a_concepto" placeholder="Detalle (p.ej. Completo / Shampoo)" />
          </div>
          <div>
            <label for="a_monto">Monto (ARS)</label>
            <input id="a_monto" placeholder="25000" inputmode="decimal" />
          </div>
          <div>
            <label for="a_medio">Medio</label>
            <select id="a_medio"><option value="Efectivo">Efectivo</option><option value="Transferencia">Transferencia</option></select>
          </div>
          <div>
            <label for="a_estado">Estado</label>
            <select id="a_estado"><option value="Pagado">Pagado</option><option value="Pendiente">Pendiente</option></select>
          </div>
          <div>
            <label for="a_factura">Factura</label>
            <input id="a_factura" placeholder="C0001-000123" />
          </div>
          <div>
            <label for="a_cliente">Cliente</label>
            <input id="a_cliente" placeholder="Juan Pérez" />
          </div>
          <div class="colspan">
            <label for="a_notas">Notas</label>
            <input id="a_notas" placeholder="Observaciones" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="primary" id="btn_agregar">Agregar</button>
          <div id="alta_msg" class="msg"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal borrar -->
  <div class="modal" id="modal_del">
    <div class="panel">
      <h3 style="margin:0 0 8px">Confirmar borrado</h3>
      <p class="muted">¿Querés borrar este movimiento? Esta acción no se puede deshacer.</p>
      <div class="row" style="justify-content:flex-end; margin-top:10px">
        <button class="ghost" id="md_cancel">Cancelar</button>
        <button class="warn" id="md_delete">Borrar</button>
      </div>
    </div>
  </div>

<script>
/* ========================
   CONFIG (URL fija)
======================== */
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyDd--FDaQPnqG_LQ4MzLuRmIQc99Y0WK1Axpwh3Tc4GX1DLCHn77XTr2-wBZUVCuVO/exec';
const apiUrl = (params) => WEBAPP_URL + '?' + new URLSearchParams({ ...params, t: Date.now() }).toString();

/* ========================
   CATEGORÍAS (mostrar capitalizado)
======================== */
const CATS_INGRESO = ['Lavado','Extra','Propina','Otros'];
const CATS_GASTO   = ['Insumos','Herramientas','Mantenimiento','Publicidad','Impuestos','Otros'];

/* helpers: mostrar Capitalizado pero enviar minúscula al backend */
const toApi = s => String(s||'').toLowerCase();
const capitalize = s => s ? s.charAt(0).toUpperCase()+s.slice(1) : s;

/* ========================
   UTILIDADES
======================== */
const $tbody = document.getElementById('tbody');
const $cards = document.getElementById('cards_list');
const $listMsg = document.getElementById('list_msg');
const $ing = document.getElementById('k_ingresos');
const $gas = document.getElementById('k_gastos');
const $net = document.getElementById('k_neto');

function fmtMoney(n){ return Number(n||0).toLocaleString('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}); }
function ymd(d){ return d.toISOString().slice(0,10); }
function firstDayOfWeek(d){ const x = new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); return x; }
function lastDayOfWeek(d){ const x = firstDayOfWeek(d); x.setDate(x.getDate()+6); return x; }
function firstDayOfMonth(d){ const x = new Date(d); x.setDate(1); return x; }
function lastDayOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
function esc(s){ return String(s||'').replace(/[&<>]/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
function pillEstado(s){ const m=String(s||'').toLowerCase(); let cls=''; if(m==='pagado')cls='ok'; else if(m==='pendiente')cls='warn'; else cls='bad'; return `<span class="pill ${cls}">${capitalize(m)}</span>`; }

/* ========================
   FILTROS
======================== */
const $from = document.getElementById('f_from');
const $to = document.getElementById('f_to');
const $tipo = document.getElementById('f_tipo');           // Ingreso | Gasto
const $estado = document.getElementById('f_estado');       // Pagado | Pendiente
const $medio = document.getElementById('f_medio');         // Efectivo | Transferencia
const $catF = document.getElementById('f_categoria');
const $quickbar = document.getElementById('quickbar');

function fillSelectOptions(sel, items, includeAll=false){
  const opts = (includeAll? [''] : []).concat(items);
  sel.innerHTML = opts.map(v=>{
    const label = v==='' ? 'Todas' : v;
    const val = v;
    return `<option value="${val}">${label}</option>`;
  }).join('');
}
function refreshFilterCategories(){
  const t = $tipo.value;
  if (!t){ fillSelectOptions($catF, [...new Set([...CATS_INGRESO, ...CATS_GASTO])], true); }
  else if (t==='Ingreso'){ fillSelectOptions($catF, CATS_INGRESO, true); }
  else { fillSelectOptions($catF, CATS_GASTO, true); }
}
$tipo.addEventListener('change', refreshFilterCategories);

/* ---- RANGOS RÁPIDOS con activo ---- */
function clearQuickActive(){
  $quickbar.querySelectorAll('.btn-filter').forEach(b=>b.classList.remove('active'));
}
function setQuickActive(btn){
  clearQuickActive();
  if (btn) btn.classList.add('active');
}
function applyRange(range){
  const d=new Date();
  if (range==='hoy'){
    $from.value=ymd(d); $to.value=ymd(d);
  }else if(range==='ayer'){
    d.setDate(d.getDate()-1); $from.value=ymd(d); $to.value=ymd(d);
  }else if(range==='semana'){
    $from.value=ymd(firstDayOfWeek(d)); $to.value=ymd(lastDayOfWeek(d));
  }else if(range==='mes'){
    $from.value=ymd(firstDayOfMonth(d)); $to.value=ymd(lastDayOfMonth(d));
  }else if(range==='todo'){
    $from.value=''; $to.value=''; // sin límites -> trae todo
  }
}
$quickbar.addEventListener('click', (ev)=>{
  const btn = ev.target.closest('.btn-filter'); if(!btn) return;
  const range = btn.dataset.range;
  applyRange(range);
  setQuickActive(btn);
});

/* si el usuario toca fechas a mano, desactivo el rango activo */
[$from,$to].forEach(i=> i.addEventListener('input', ()=> clearQuickActive()));

document.getElementById('btn_buscar').onclick = cargarLista;
document.getElementById('btn_export').onclick = exportCSV;

async function cargarLista(){
  try{
    $listMsg.textContent = 'Cargando…';
    const params = { action:'caja_list' };
    if ($from.value) params.from=$from.value;
    if ($to.value) params.to=$to.value;
    if ($tipo.value) params.tipo=toApi($tipo.value);
    if ($estado.value) params.estado=toApi($estado.value);
    if ($medio.value) params.medio=toApi($medio.value);
    if ($catF.value) params.categoria=$catF.value;
    const res = await fetch(apiUrl(params));
    const j = await res.json();
    if (!j.ok) throw new Error(j.error||'No se pudo listar');
    renderTabla(j.rows||[]);
    renderCards(j.rows||[]);
    const t = j.total || { ingresos:0, gastos:0, neto:0 };
    $ing.textContent = fmtMoney(t.ingresos);
    $gas.textContent = fmtMoney(t.gastos);
    $net.textContent = fmtMoney(t.neto);
    $listMsg.textContent = '';
  }catch(e){ $listMsg.textContent = '⚠️ '+e.message; }
}

/* ========================
   TABLA + EDITOR INLINE
======================== */
function renderTabla(rows){
  const $tbody = document.getElementById('tbody');
  $tbody.innerHTML = '';
  if (!rows.length){ $tbody.innerHTML = '<tr><td colspan="10" class="muted">Sin movimientos</td></tr>'; return; }
  for (const r of rows){
    const tr = document.createElement('tr');
    tr.dataset.id = r.id;
    tr.innerHTML = `
      <td>${r.fecha||''}</td>
      <td>${capitalize(r.tipo||'')}</td>
      <td>${r.categoria||''}</td>
      <td>${esc(r.concepto)||''}</td>
      <td class="right">${fmtMoney(r.monto_ars||0)}</td>
      <td>${capitalize(r.medio||'')}</td>
      <td>${pillEstado(r.estado||'')}</td>
      <td>${esc(r.factura||'')}</td>
      <td>${esc(r.cliente||'')}</td>
      <td class="right">
        <button class="ghost" data-act="edit">Editar</button>
        <button class="warn" data-act="del">Borrar</button>
      </td>`;
    $tbody.appendChild(tr);
  }
}

function buildEditRow(r){
  const div = document.createElement('div');
  div.className = 'grid cols-4';
  div.style.marginTop = '10px';
  div.innerHTML = `
    <div><label>Fecha</label><input type="date" name="fecha" value="${r.fecha||''}"></div>
    <div><label>Tipo</label>
      <select name="tipo">
        <option ${capitalize(r.tipo)==='Ingreso'?'selected':''}>Ingreso</option>
        <option ${capitalize(r.tipo)==='Gasto'?'selected':''}>Gasto</option>
      </select>
    </div>
    <div><label>Categoría</label><select name="categoria"></select></div>
    <div><label>Medio</label>
      <select name="medio">
        <option ${capitalize(r.medio)==='Efectivo'?'selected':''}>Efectivo</option>
        <option ${capitalize(r.medio)==='Transferencia'?'selected':''}>Transferencia</option>
      </select>
    </div>
    <div class="colspan"><label>Concepto</label><input name="concepto" value="${esc(r.concepto)}"></div>
    <div><label>Monto</label><input name="monto" value="${r.monto_ars||0}" inputmode="decimal"></div>
    <div><label>Estado</label>
      <select name="estado">
        <option ${capitalize(r.estado)==='Pagado'?'selected':''}>Pagado</option>
        <option ${capitalize(r.estado)==='Pendiente'?'selected':''}>Pendiente</option>
      </select>
    </div>
    <div><label>Factura</label><input name="factura" value="${esc(r.factura)}"></div>
    <div><label>Cliente</label><input name="cliente" value="${esc(r.cliente)}"></div>
    <div class="row" style="grid-column:1/-1; justify-content:flex-end; gap:8px">
      <button class="ghost" data-cancel>Cancelar</button>
      <button class="primary" data-save>Guardar</button>
      <span class="msg"></span>
    </div>`;
  const tipoSel = div.querySelector('select[name="tipo"]');
  const catSel  = div.querySelector('select[name="categoria"]');
  const fill = ()=>{
    const list = (tipoSel.value==='Ingreso') ? CATS_INGRESO : CATS_GASTO;
    catSel.innerHTML = list.map(v=>`<option>${v}</option>`).join('');
  };
  fill(); catSel.value = r.categoria || '';
  tipoSel.addEventListener('change', fill);
  return div;
}

const $modal = document.getElementById('modal_del');
const $mdCancel = document.getElementById('md_cancel');
const $mdDelete = document.getElementById('md_delete');
let modalDeleteId = null;

document.getElementById('tbody').addEventListener('click', async (ev)=>{
  const btn = ev.target.closest('button'); if(!btn) return;
  const tr = btn.closest('tr'); const id = tr.dataset.id;
  const act = btn.dataset.act;

  if (act==='del'){
    modalDeleteId = id; $modal.style.display='flex';
    return;
  }

  if (act==='edit'){
    if (tr.nextElementSibling && tr.nextElementSibling.classList.contains('edit-holder')){
      tr.nextElementSibling.remove(); return;
    }
    const r = {
      id,
      fecha: tr.children[0].textContent.trim(),
      tipo: tr.children[1].textContent.trim(),
      categoria: tr.children[2].textContent.trim(),
      concepto: tr.children[3].textContent.trim(),
      monto_ars: Number(tr.children[4].textContent.replace(/[^\d,-]/g,'').replace('.','').replace(',','.')) || 0,
      medio: tr.children[5].textContent.trim(),
      estado: tr.children[6].innerText.trim(),
      factura: tr.children[7].textContent.trim(),
      cliente: tr.children[8].textContent.trim()
    };
    const holder = document.createElement('tr'); holder.className='edit-holder';
    const td = document.createElement('td'); td.colSpan=10; td.style.background='#0f172a'; td.style.border='1px dashed var(--line)';
    const editor = buildEditRow({ ...r, tipo:r.tipo, medio:r.medio, estado:r.estado });
    td.appendChild(editor); holder.appendChild(td);
    tr.insertAdjacentElement('afterend', holder);

    const msg = editor.querySelector('.msg');
    const btnSave = editor.querySelector('[data-save]');
    const btnCancel = editor.querySelector('[data-cancel]');
    btnCancel.onclick = ()=> holder.remove();
    btnSave.onclick = async ()=>{
      try{
        btnSave.disabled = true; btnSave.textContent = 'Guardando…'; msg.textContent='';
        const data = {};
        editor.querySelectorAll('input,select,textarea').forEach(i=>{
          if (!i.name) return;
          let val = i.value;
          if (i.name==='tipo' || i.name==='estado' || i.name==='medio') val = toApi(val);
          data[i.name] = val;
        });
        const params = new URLSearchParams({ action:'caja_update', id });
        Object.entries(data).forEach(([k,v])=> params.append(k,v));
        const r = await fetch(apiUrl(Object.fromEntries(params)));
        const j = await r.json();
        if (!j.ok) throw new Error(j.error||'No se pudo actualizar');
        holder.remove(); await cargarLista();
      }catch(e){ msg.textContent = '⚠️ '+e.message; }
      finally{ btnSave.disabled=false; btnSave.textContent='Guardar'; }
    };
  }
});

// Modal delete
$mdCancel.onclick = ()=>{ modalDeleteId=null; $modal.style.display='none'; };
$mdDelete.onclick = async ()=>{
  if (!modalDeleteId) return;
  try{
    const r = await fetch(apiUrl({action:'caja_delete', id: modalDeleteId}));
    const j = await r.json();
    if (!j.ok) throw new Error(j.error||'No se pudo borrar');
    $modal.style.display='none'; modalDeleteId=null; await cargarLista();
  }catch(e){ alert('Error: '+e.message); }
};

/* ========================
   CARDS (mobile)
======================== */
function renderCards(rows){
  $cards.innerHTML = '';
  for (const r of rows){
    const div = document.createElement('div');
    div.className = 'card-row';
    div.dataset.id = r.id;
    div.innerHTML = `
      <div class="line"><span class="label">Fecha</span><span>${r.fecha||''}</span></div>
      <div class="line"><span class="label">Tipo</span><span>${capitalize(r.tipo||'')}</span></div>
      <div class="line"><span class="label">Categoría</span><span>${r.categoria||''}</span></div>
      <div class="line"><span class="label">Concepto</span><span>${esc(r.concepto||'')}</span></div>
      <div class="line"><span class="label">Monto</span><span>${fmtMoney(r.monto_ars||0)}</span></div>
      <div class="line"><span class="label">Medio</span><span>${capitalize(r.medio||'')}</span></div>
      <div class="line"><span class="label">Estado</span><span>${capitalize(r.estado||'')}</span></div>
      <div class="line"><span class="label">Factura</span><span>${esc(r.factura||'')}</span></div>
      <div class="line"><span class="label">Cliente</span><span>${esc(r.cliente||'')}</span></div>
      <div class="row" style="justify-content:flex-end; margin-top:8px; gap:8px">
        <button class="ghost" data-edit="${r.id}">Editar</button>
        <button class="warn" data-del="${r.id}">Borrar</button>
      </div>`;
    $cards.appendChild(div);
  }
}
$cards.addEventListener('click', (ev)=>{
  const b = ev.target.closest('button'); if(!b) return;
  const id = b.dataset.edit || b.dataset.del;
  if (b.dataset.del){ modalDeleteId=id; $modal.style.display='flex'; return; }
  const tr = $tbody.querySelector(`tr[data-id="${id}"]`);
  if (tr){ tr.querySelector('button[data-act="edit"]').click(); window.scrollTo({top:tr.getBoundingClientRect().top + window.scrollY - 120, behavior:'smooth'}); }
});

/* ========================
   ALTA
======================== */
const $a_fecha = document.getElementById('a_fecha');
const $a_tipo = document.getElementById('a_tipo');
const $a_categoria = document.getElementById('a_categoria');
const $a_categoria_otro = document.getElementById('a_categoria_otro');
const $a_categoria_otro_wrap = document.getElementById('a_categoria_otro_wrap');
const $a_medio = document.getElementById('a_medio');
const $a_concepto = document.getElementById('a_concepto');
const $a_monto = document.getElementById('a_monto');
const $a_estado = document.getElementById('a_estado');
const $a_factura = document.getElementById('a_factura');
const $a_cliente = document.getElementById('a_cliente');
const $a_notas = document.getElementById('a_notas');
const $altaMsg = document.getElementById('alta_msg');
const $btnAgregar = document.getElementById('btn_agregar');

function refreshAltaCategorias(){
  const list = ($a_tipo.value==='Ingreso') ? CATS_INGRESO : CATS_GASTO;
  $a_categoria.innerHTML = list.map(v=>`<option>${v}</option>`).join('');
  $a_categoria.value = list[0] || 'Otros';
  toggleOtro();
}
function toggleOtro(){
  const isOtro = $a_categoria.value==='Otros';
  $a_categoria_otro_wrap.style.display = isOtro? '' : 'none';
  if (!isOtro) $a_categoria_otro.value='';
}
$a_tipo.addEventListener('change', refreshAltaCategorias);
$a_categoria.addEventListener('change', toggleOtro);

document.getElementById('btn_agregar').onclick = async ()=>{
  $altaMsg.textContent = '';
  try{
    $btnAgregar.disabled=true; $btnAgregar.textContent='Agregando…';
    const categoria = ($a_categoria.value==='Otros' && $a_categoria_otro.value.trim()) ? $a_categoria_otro.value.trim() : $a_categoria.value;
    const req = {
      action:'caja_add',
      fecha:$a_fecha.value || ymd(new Date()),
      tipo:toApi($a_tipo.value),
      categoria:categoria,
      concepto:$a_concepto.value.trim(),
      monto:$a_monto.value.replace(',','.'),
      medio:toApi($a_medio.value),
      estado:toApi($a_estado.value),
      factura:$a_factura.value.trim(),
      cliente:$a_cliente.value.trim(),
      notas:$a_notas.value.trim()
    };
    if (!req.concepto || !req.monto) throw new Error('Completá concepto y monto');
    const r = await fetch(apiUrl(req));
    const j = await r.json();
    if (!j.ok) throw new Error(j.error||'No se pudo agregar');
    $altaMsg.textContent = 'Agregado ✔';
    $a_concepto.value=''; $a_monto.value=''; $a_factura.value=''; $a_notas.value='';
    await cargarLista();
  }catch(e){ $altaMsg.textContent = '⚠️ '+e.message; }
  finally{ $btnAgregar.disabled=false; $btnAgregar.textContent='Agregar'; }
};

/* ========================
   EXPORT CSV
======================== */
function exportCSV(){
  const rows = [...$tbody.querySelectorAll('tr')].map(tr=>[
    tr.children[0].innerText.trim(),
    tr.children[1].innerText.trim(),
    tr.children[2].innerText.trim(),
    tr.children[3].innerText.trim(),
    tr.children[4].innerText.trim(),
    tr.children[5].innerText.trim(),
    tr.children[6].innerText.trim(),
    tr.children[7].innerText.trim(),
    tr.children[8].innerText.trim()
  ]);
  if (!rows.length){ alert('No hay datos para exportar'); return; }
  const header = ['Fecha','Tipo','Categoría','Concepto','Monto','Medio','Estado','Factura','Cliente'];
  const csv = [header].concat(rows).map(r=>r.map(cell=> '"'+cell.replace(/"/g,'""')+'"').join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'caja_'+ Date.now() +'.csv'; a.click();
  URL.revokeObjectURL(url);
}

/* ========================
   INIT
======================== */
(function init(){
  // por defecto: mes actual y botón activo
  document.getElementById('btn_period_mes').click();
  refreshFilterCategories();
  refreshAltaCategorias();
  cargarLista();
})();
</script>
</body>
</html>
