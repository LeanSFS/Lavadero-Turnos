<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LyS Lavados — Admin Caja</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <style>
    :root{ --bg:#0f172a; --card:#0b1220; --line:#1f2937; --muted:#9ca3af; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444 }
    html,body{height:100%}
    body{ margin:0; background:var(--bg); color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, sans-serif; }
    .wrap{ max-width:1100px; margin:0 auto; padding:24px; }
    .box{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:18px; }
    h1{ margin:0 0 16px; font-size:22px; text-align:left }
    .muted{ color:var(--muted) }
    .grid{ display:grid; gap:12px }
    .grid.cols-3{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    .grid.cols-4{ grid-template-columns: repeat(4, minmax(0,1fr)); }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    label{ font-size:12px; color:var(--muted) }
    input, select, textarea{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#0f172a; color:#fff }
    button{ padding:10px 14px; border-radius:10px; border:1px solid var(--line); background:#111827; color:#e5e7eb; cursor:pointer }
    button.primary{ border-color:var(--ok); background:var(--ok); color:#0b1220; font-weight:800 }
    button.warn{ border-color:var(--warn); background:var(--warn); color:#0b1220; font-weight:700 }
    button.ghost{ background:#0f172a }
    button:disabled{ opacity:.6; cursor:not-allowed }
    .toolbar{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:12px }
    .cards{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px; margin:10px 0 14px }
    .card{ background:#111827; border:1px solid var(--line); border-radius:12px; padding:12px }
    .card h3{ margin:0 0 6px; font-size:13px; color:var(--muted) }
    .card .num{ font-weight:800; font-size:20px }

    table{ width:100%; border-collapse:collapse; }
    th, td{ border-bottom:1px solid var(--line); padding:10px; text-align:left; vertical-align:top }
    th{ color:#e5e7eb; font-weight:700; font-size:12px }
    tr:hover td{ background:#0f172a }
    .right{ text-align:right }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line); background:#0f172a }
    .pill.ok{ background:rgba(34,197,94,.12); border-color:#1b6d3b }
    .pill.bad{ background:rgba(239,68,68,.12); border-color:#7a2222 }
    .pill.warn{ background:rgba(245,158,11,.12); border-color:#8a5a10 }

    .section{ margin-top:18px }
    .msg{ margin-top:8px; color:var(--muted); white-space:pre-wrap }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0 }

    /* Responsive */
    @media (max-width:900px){ .cards{ grid-template-columns:1fr } .grid.cols-4{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width:600px){ .grid.cols-3{ grid-template-columns:1fr } }

    /* Inline editor */
    .edit-row{ background:#0f172a; border:1px dashed var(--line); border-radius:12px; padding:12px; margin-top:10px }
  </style>
</head>
<body>
  <main class="wrap">
    <div class="box">
      <h1>Gestión — Caja (Ingresos / Gastos)</h1>

      <!-- CONFIG API -->
      <details>
        <summary class="muted">Configurar conexión (WEBAPP_URL y API_KEY)</summary>
        <div class="grid cols-3" style="margin-top:10px">
          <div>
            <label for="api_url">WEBAPP_URL</label>
            <input id="api_url" placeholder="https://script.google.com/macros/s/XXX/exec" />
          </div>
          <div>
            <label for="api_key">API_KEY (opcional)</label>
            <input id="api_key" placeholder="si la activaste en backend" />
          </div>
          <div class="row" style="margin-top:20px">
            <button class="primary" id="btn_save_api">Guardar conexión</button>
            <button class="ghost" id="btn_test_api">Probar</button>
          </div>
        </div>
        <div id="api_msg" class="msg"></div>
      </details>

      <!-- FILTROS -->
      <div class="section">
        <div class="toolbar">
          <div class="row" style="gap:8px; flex-wrap:wrap">
            <div>
              <label for="f_from">Desde</label>
              <input type="date" id="f_from" />
            </div>
            <div>
              <label for="f_to">Hasta</label>
              <input type="date" id="f_to" />
            </div>
            <div>
              <label for="f_tipo">Tipo</label>
              <select id="f_tipo"><option value="">Todos</option><option>ingreso</option><option>gasto</option></select>
            </div>
            <div>
              <label for="f_estado">Estado</label>
              <select id="f_estado"><option value="">Todos</option><option>pagado</option><option>pendiente</option><option>anulado</option></select>
            </div>
            <div>
              <label for="f_medio">Medio</label>
              <select id="f_medio"><option value="">Todos</option><option>efectivo</option><option>transfer</option><option>mp</option><option>tarjeta</option></select>
            </div>
            <div>
              <label for="f_categoria">Categoría</label>
              <input id="f_categoria" placeholder="Lavado, Insumos…" />
            </div>
          </div>
          <div class="row">
            <button id="btn_period_hoy">Hoy</button>
            <button id="btn_period_mes">Este mes</button>
            <button class="primary" id="btn_buscar">Buscar</button>
            <button class="ghost" id="btn_export">Exportar CSV</button>
          </div>
        </div>
        <div id="list_msg" class="msg"></div>
      </div>

      <!-- CARDS -->
      <div class="cards">
        <div class="card"><h3>Ingresos</h3><div class="num" id="k_ingresos">$ 0</div></div>
        <div class="card"><h3>Gastos</h3><div class="num" id="k_gastos">$ 0</div></div>
        <div class="card"><h3>Neto</h3><div class="num" id="k_neto">$ 0</div></div>
      </div>

      <!-- TABLA -->
      <div class="section">
        <div class="box" style="background:#0f172a; border-radius:12px">
          <table id="tabla">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Categoría</th>
                <th>Concepto</th>
                <th class="right">Monto</th>
                <th>Medio</th>
                <th>Estado</th>
                <th>Factura</th>
                <th>Cliente</th>
                <th>Turno</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- ALTA RÁPIDA -->
      <div class="section">
        <h2 style="font-size:18px; margin:0 0 10px">Agregar movimiento</h2>
        <div class="grid cols-4">
          <div>
            <label for="a_fecha">Fecha</label>
            <input type="date" id="a_fecha" />
          </div>
          <div>
            <label for="a_tipo">Tipo</label>
            <select id="a_tipo"><option>ingreso</option><option>gasto</option></select>
          </div>
          <div>
            <label for="a_categoria">Categoría</label>
            <input id="a_categoria" placeholder="Lavado, Insumos…" />
          </div>
          <div>
            <label for="a_medio">Medio</label>
            <select id="a_medio"><option>efectivo</option><option>transfer</option><option>mp</option><option>tarjeta</option></select>
          </div>
          <div class="colspan">
            <label for="a_concepto">Concepto</label>
            <input id="a_concepto" placeholder="Detalle (p.ej. Completo Sedan / Shampoo Toxic)" />
          </div>
          <div>
            <label for="a_monto">Monto (ARS)</label>
            <input id="a_monto" placeholder="25000" inputmode="decimal" />
          </div>
          <div>
            <label for="a_estado">Estado</label>
            <select id="a_estado"><option>pagado</option><option>pendiente</option><option>anulado</option></select>
          </div>
          <div>
            <label for="a_factura">Factura</label>
            <input id="a_factura" placeholder="C0001-000123" />
          </div>
          <div>
            <label for="a_turno">Turno ID (opcional)</label>
            <input id="a_turno" placeholder="id del turno" />
          </div>
          <div>
            <label for="a_cliente">Cliente</label>
            <input id="a_cliente" placeholder="Juan Pérez" />
          </div>
          <div class="colspan">
            <label for="a_notas">Notas</label>
            <input id="a_notas" placeholder="observaciones" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="primary" id="btn_agregar">Agregar</button>
          <div id="alta_msg" class="msg"></div>
        </div>
      </div>
    </div>
  </main>

  <script>
  // ===========================
  // CONFIG CLIENTE
  // ===========================
  const $apiUrl = document.getElementById('api_url');
  const $apiKey = document.getElementById('api_key');
  const $apiMsg = document.getElementById('api_msg');
  const STORAGE_KEY = 'lys_admin_api_cfg';

  const cfg = loadCfg();
  $apiUrl.value = cfg.url || '';
  $apiKey.value = cfg.key || '';

  function saveCfg(){ localStorage.setItem(STORAGE_KEY, JSON.stringify({ url:$apiUrl.value.trim(), key:$apiKey.value.trim() })); }
  function loadCfg(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}'); }catch(_){ return {}; } }
  function apiUrl(params){
    if (!cfg.url) throw new Error('Falta WEBAPP_URL en Configuración');
    const usp = new URLSearchParams(params);
    if (cfg.key) usp.set('key', cfg.key);
    usp.set('t', Date.now());
    return cfg.url + '?' + usp.toString();
  }
  document.getElementById('btn_save_api').onclick = ()=>{ saveCfg(); Object.assign(cfg, loadCfg()); $apiMsg.textContent = 'Conexión guardada ✔'; };
  document.getElementById('btn_test_api').onclick = async ()=>{
    try{ Object.assign(cfg, loadCfg()); const r = await fetch(apiUrl({action:'health'})); const j = await r.json(); $apiMsg.textContent = j.ok? 'OK: ' + (j.sheet||'') : ('Error: '+j.error); }
    catch(e){ $apiMsg.textContent = 'Error: '+e.message; }
  };

  // ===========================
  // UTILIDADES
  // ===========================
  const $tbody = document.getElementById('tbody');
  const $listMsg = document.getElementById('list_msg');
  const $ing = document.getElementById('k_ingresos');
  const $gas = document.getElementById('k_gastos');
  const $net = document.getElementById('k_neto');

  function fmtMoney(n){
    const v = Number(n||0);
    return v.toLocaleString('es-AR', { style:'currency', currency:'ARS', maximumFractionDigits:0 });
  }
  function ymd(d){ return d.toISOString().slice(0,10); }
  function firstDayOfMonth(d){ const x = new Date(d); x.setDate(1); return x; }
  function lastDayOfMonth(d){ const x = new Date(d.getFullYear(), d.getMonth()+1, 0); return x; }
  function el(tag, attrs={}, html=''){ const e = document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>e.setAttribute(k,v)); e.innerHTML = html; return e; }

  // ===========================
  // FILTROS
  // ===========================
  const $from = document.getElementById('f_from');
  const $to = document.getElementById('f_to');
  const $tipo = document.getElementById('f_tipo');
  const $estado = document.getElementById('f_estado');
  const $medio = document.getElementById('f_medio');
  const $cat = document.getElementById('f_categoria');
  document.getElementById('btn_period_hoy').onclick = ()=>{ const d=new Date(); $from.value=ymd(d); $to.value=ymd(d); };
  document.getElementById('btn_period_mes').onclick = ()=>{ const d=new Date(); $from.value=ymd(firstDayOfMonth(d)); $to.value=ymd(lastDayOfMonth(d)); };

  document.getElementById('btn_buscar').onclick = cargarLista;
  document.getElementById('btn_export').onclick = exportCSV;

  async function cargarLista(){
    try{
      Object.assign(cfg, loadCfg());
      $listMsg.textContent = 'Cargando…';
      const params = { action:'caja_list' };
      if ($from.value) params.from=$from.value;
      if ($to.value) params.to=$to.value;
      if ($tipo.value) params.tipo=$tipo.value;
      if ($estado.value) params.estado=$estado.value;
      if ($medio.value) params.medio=$medio.value;
      if ($cat.value.trim()) params.categoria=$cat.value.trim();
      const res = await fetch(apiUrl(params));
      const j = await res.json();
      if (!j.ok) throw new Error(j.error||'No se pudo listar');
      renderTabla(j.rows||[]);
      const t = j.total || { ingresos:0, gastos:0, neto:0 };
      $ing.textContent = fmtMoney(t.ingresos);
      $gas.textContent = fmtMoney(t.gastos);
      $net.textContent = fmtMoney(t.neto);
      $listMsg.textContent = '';
    }catch(e){ $listMsg.textContent = '⚠️ '+e.message; }
  }

  function renderTabla(rows){
    $tbody.innerHTML = '';
    if (!rows.length){ $tbody.innerHTML = '<tr><td colspan="11" class="muted">Sin movimientos</td></tr>'; return; }
    for (const r of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.fecha||''}</td>
        <td>${r.tipo||''}</td>
        <td>${r.categoria||''}</td>
        <td>${(r.concepto||'')}</td>
        <td class="right">${fmtMoney(r.monto_ars||0)}</td>
        <td>${r.medio||''}</td>
        <td>${pillEstado(r.estado||'')}</td>
        <td>${r.factura||''}</td>
        <td>${r.cliente||''}</td>
        <td>${r.turno_id||''}</td>
        <td class="right">
          <button class="ghost" data-act="edit" data-id="${r.id}">Editar</button>
          <button class="warn" data-act="del" data-id="${r.id}">Borrar</button>
        </td>`;
      $tbody.appendChild(tr);
      // fila de edición oculta
      const er = el('tr');
      const ec = el('td', { colspan:'11' });
      ec.appendChild(buildEditor(r));
      er.appendChild(ec); er.style.display='none';
      $tbody.appendChild(er);
    }
  }

  function pillEstado(s){
    const m = String(s||'').toLowerCase();
    let cls=''; if (m==='pagado') cls='ok'; else if (m==='pendiente') cls='warn'; else cls='bad';
    return `<span class="pill ${cls}">${s}</span>`;
  }

  function buildEditor(r){
    const box = el('div', {class:'edit-row'});
    box.innerHTML = `
      <div class="grid cols-4">
        <div><label>Fecha</label><input type="date" name="fecha" value="${r.fecha||''}"></div>
        <div><label>Tipo</label><select name="tipo"><option ${r.tipo==='ingreso'?'selected':''}>ingreso</option><option ${r.tipo==='gasto'?'selected':''}>gasto</option></select></div>
        <div><label>Categoría</label><input name="categoria" value="${esc(r.categoria)}"></div>
        <div><label>Medio</label><select name="medio"><option ${r.medio==='efectivo'?'selected':''}>efectivo</option><option ${r.medio==='transfer'?'selected':''}>transfer</option><option ${r.medio==='mp'?'selected':''}>mp</option><option ${r.medio==='tarjeta'?'selected':''}>tarjeta</option></select></div>
        <div class="colspan"><label>Concepto</label><input name="concepto" value="${esc(r.concepto)}"></div>
        <div><label>Monto</label><input name="monto" value="${r.monto_ars||0}" inputmode="decimal"></div>
        <div><label>Estado</label><select name="estado"><option ${r.estado==='pagado'?'selected':''}>pagado</option><option ${r.estado==='pendiente'?'selected':''}>pendiente</option><option ${r.estado==='anulado'?'selected':''}>anulado</option></select></div>
        <div><label>Factura</label><input name="factura" value="${esc(r.factura)}"></div>
        <div><label>Turno ID</label><input name="turno_id" value="${esc(r.turno_id)}"></div>
        <div><label>Cliente</label><input name="cliente" value="${esc(r.cliente)}"></div>
        <div class="colspan"><label>Notas</label><input name="notas" value="${esc(r.notas)}"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="primary" data-save="${r.id}">Guardar cambios</button>
        <span class="msg"></span>
      </div>`;
    return box;
  }

  function esc(s){ return String(s||'').replace(/[&<>]/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

  // Delegación de eventos para editar / borrar / togglear editor
  $tbody.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('button'); if(!btn) return;
    const act = btn.dataset.act; const id = btn.dataset.id;
    const tr = btn.closest('tr'); const editRow = tr.nextElementSibling; // nuestra fila oculta
    if (act==='edit'){
      editRow.style.display = editRow.style.display==='none' ? '' : 'none';
      return;
    }
    if (act==='del'){
      if (!confirm('¿Borrar este movimiento?')) return;
      try{
        Object.assign(cfg, loadCfg());
        const r = await fetch(apiUrl({action:'caja_delete', id}));
        const j = await r.json();
        if (!j.ok) throw new Error(j.error||'No se pudo borrar');
        tr.remove(); editRow.remove();
      }catch(e){ alert('Error: '+e.message); }
      return;
    }
    // Guardar desde editor
    const saveId = btn.dataset.save;
    if (saveId){
      const editor = btn.closest('.edit-row');
      const msg = editor.querySelector('.msg');
      const data = {};
      editor.querySelectorAll('input,select,textarea').forEach(i=>{ if (i.value!=='' ) data[i.name]= i.value; });
      try{
        Object.assign(cfg, loadCfg());
        const params = new URLSearchParams({ action:'caja_update', id: saveId });
        Object.entries(data).forEach(([k,v])=> params.append(k,v));
        const r = await fetch(apiUrl(Object.fromEntries(params)));
        const j = await r.json();
        if (!j.ok) throw new Error(j.error||'No se pudo actualizar');
        msg.textContent = 'Actualizado ✔';
        await cargarLista();
      }catch(e){ msg.textContent = '⚠️ '+e.message; }
    }
  });

  // ===========================
  // ALTA
  // ===========================
  const $a_fecha = document.getElementById('a_fecha');
  const $a_tipo = document.getElementById('a_tipo');
  const $a_categoria = document.getElementById('a_categoria');
  const $a_medio = document.getElementById('a_medio');
  const $a_concepto = document.getElementById('a_concepto');
  const $a_monto = document.getElementById('a_monto');
  const $a_estado = document.getElementById('a_estado');
  const $a_factura = document.getElementById('a_factura');
  const $a_turno = document.getElementById('a_turno');
  const $a_cliente = document.getElementById('a_cliente');
  const $a_notas = document.getElementById('a_notas');
  const $altaMsg = document.getElementById('alta_msg');
  document.getElementById('btn_agregar').onclick = async ()=>{
    $altaMsg.textContent = '';
    try{
      Object.assign(cfg, loadCfg());
      const req = {
        action:'caja_add',
        fecha:$a_fecha.value || ymd(new Date()),
        tipo:$a_tipo.value,
        categoria:$a_categoria.value.trim(),
        concepto:$a_concepto.value.trim(),
        monto:$a_monto.value.replace(',','.'),
        medio:$a_medio.value,
        estado:$a_estado.value,
        factura:$a_factura.value.trim(),
        turno_id:$a_turno.value.trim(),
        cliente:$a_cliente.value.trim(),
        notas:$a_notas.value.trim()
      };
      if (!req.concepto || !req.monto) throw new Error('Completá concepto y monto');
      const r = await fetch(apiUrl(req));
      const j = await r.json();
      if (!j.ok) throw new Error(j.error||'No se pudo agregar');
      $altaMsg.textContent = 'Agregado ✔';
      // limpiar mínimos
      $a_concepto.value=''; $a_monto.value=''; $a_factura.value=''; $a_notas.value='';
      await cargarLista();
    }catch(e){ $altaMsg.textContent = '⚠️ '+e.message; }
  };

  // ===========================
  // EXPORT CSV
  // ===========================
  function exportCSV(){
    const rows = [...$tbody.querySelectorAll('tr')].map(tr=>[...tr.children].slice(0,10).map(td=>td.innerText.replace(/\n/g,' ').trim()));
    if (!rows.length){ alert('No hay datos para exportar'); return; }
    const header = ['Fecha','Tipo','Categoría','Concepto','Monto','Medio','Estado','Factura','Cliente','Turno'];
    const csv = [header].concat(rows).map(r=>r.map(cell=> '"'+cell.replace(/"/g,'""')+'"').join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'caja_'+ Date.now() +'.csv'; a.click();
    URL.revokeObjectURL(url);
  }

  // ===========================
  // INIT: periodo por defecto = mes actual
  // ===========================
  (function init(){
    const d = new Date();
    document.getElementById('btn_period_mes').click();
    // Sugerir valores iniciales de API si no hay
    if (!cfg.url) $apiMsg.textContent = '⚠️ Cargá tu WEBAPP_URL arriba y guardá';
    // Si ya hay URL, cargar lista
    if (cfg.url) cargarLista();
  })();
  </script>
</body>
</html>
